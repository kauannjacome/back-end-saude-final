generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model subscriber {
  id                  Int                 @id @default(autoincrement())
  uuid                String              @unique @default(uuid())
  name                String
  municipality_name   String
  email               String
  telephone           String
  cnpj                String              @unique
  postal_code         String
  city                String
  neighborhood        String
  street              String
  number              String
  state_name          String
  state_acronym       String
  state_logo          String?
  municipal_logo      String?
  administration_logo String?
  payment             Boolean             @default(true)
  is_blocked          Boolean             @default(false)
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt
  deleted_at          DateTime?
  audit_logs          audit_log[]
  cares               care[]
  folders             folder[]
  groups              group[]
  patients            patient[]
  professionals       professional[]
  regulations         regulation[]
  suppliers           supplier[]
  units               unit[]
  notifications       notification[]
  whatsapp_config     whatsapp_config?
  suggestions         suggestion[]
  chatConversations   chat_conversation[]
  care_regulations    care_regulation[]
  care_usage_ranks    care_usage_rank[]
  chat_messages       chat_message[]
}

model unit {
  id            Int        @id @default(autoincrement())
  uuid          String     @unique @default(uuid())
  subscriber_id Int
  name          String
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  deleted_at    DateTime?
  subscriber    subscriber @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@index([subscriber_id])
}

model audit_log {
  id            Int           @id @default(autoincrement())
  uuid          String        @unique @default(uuid())
  subscriber_id Int
  actor_id      Int?
  object_type   String
  object_id     Int
  action        audit_action
  detail        Json
  occurred_at   DateTime      @default(now())
  actor         professional? @relation(fields: [actor_id], references: [id])
  subscriber    subscriber    @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@index([subscriber_id])
  @@index([actor_id])
  @@index([object_type, object_id])
}

model care {
  id              Int              @id @default(autoincrement())
  uuid            String           @unique @default(uuid())
  subscriber_id   Int
  name            String
  name_normalized String?
  acronym         String?
  description     String?
  status          status?          @default(in_progress)
  resource_origin resource_origin? @default(nao_especificado)
  priority        priority?        @default(eletivo)
  unit_measure    unit_measure

  type_declaration  type_declaration?
  value             Float?
  amount            Int?
  min_deadline_days Int?
  group_id          Int?
  professional_id   Int?
  supplier_id       Int?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  deleted_at        DateTime?
  group             group?            @relation(fields: [group_id], references: [id])
  professional      professional?     @relation(fields: [professional_id], references: [id])
  subscriber        subscriber        @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  supplier          supplier?         @relation(fields: [supplier_id], references: [id])
  regulations       care_regulation[]
  usage_ranks       care_usage_rank[]

  @@index([subscriber_id])
  @@index([group_id])
  @@index([professional_id])
}

model folder {
  id             Int           @id @default(autoincrement())
  uuid           String        @unique @default(uuid())
  subscriber_id  Int
  name           String
  id_code        String?
  description    String?
  responsible_id Int?
  start_date     DateTime?
  end_date       DateTime?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt
  deleted_at     DateTime?
  responsible    professional? @relation("ProfessionalResponsible", fields: [responsible_id], references: [id])
  subscriber     subscriber    @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  regulations    regulation[]

  @@index([subscriber_id])
}

model group {
  id            Int        @id @default(autoincrement())
  uuid          String     @unique @default(uuid())
  subscriber_id Int
  name          String
  description   String?
  created_at    DateTime   @default(now())
  updated_at    DateTime   @updatedAt
  deleted_at    DateTime?
  cares         care[]
  subscriber    subscriber @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@index([subscriber_id])
}

model patient {
  id                     Int          @id @default(autoincrement())
  uuid                   String       @unique @default(uuid())
  subscriber_id          Int
  cpf                    String
  cns                    String?
  name                   String
  name_normalized        String?
  social_name            String?
  gender                 String?
  race                   String?
  sex                    String?
  birth_date             DateTime
  death_date             DateTime?
  mother_name            String?
  father_name            String?
  phone                  String?
  email                  String?
  postal_code            String?
  state                  String?
  city                   String?
  address                String?
  number                 String?
  complement             String?
  neighborhood           String?
  nationality            String?
  naturalness            String?
  marital_status         String?
  blood_type             String?
  password_hash          String?
  is_password_temp       Boolean      @default(false)
  number_try             Int?         @default(0)
  is_blocked             Boolean      @default(false)
  accepted_terms         Boolean      @default(false)
  accepted_terms_at      DateTime?
  accepted_terms_version String?
  created_at             DateTime     @default(now())
  updated_at             DateTime     @updatedAt
  deleted_at             DateTime?
  subscriber             subscriber   @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  regulations            regulation[] @relation("PatientRegulation")
  responsible_for        regulation[] @relation("ResponsibleRegulation")

  @@unique([subscriber_id, cpf])
  @@index([subscriber_id])
}

model professional {
  id                     Int               @id @default(autoincrement())
  uuid                   String            @unique @default(uuid())
  subscriber_id          Int
  cpf                    String
  name                   String?
  name_normalized        String?
  cargo                  String?
  sex                    sex?
  birth_date             DateTime?
  phone_number           String?
  email                  String?
  cns                    String? // Cartão Nacional de Saúde
  professional_registry  String? // Ex: "CRM-SP 123456" - Campo composto/display
  registry_type          String? // Ex: "CRM", "COREN", "CRO"
  registry_number        String? // Ex: "123456"
  registry_state         String? // Ex: "SP", "RJ"
  role                   role?             @default(typist)
  password_hash          String?
  is_password_temp       Boolean           @default(false)
  number_try             Int?              @default(0)
  is_blocked             Boolean           @default(false)
  accepted_terms         Boolean           @default(false)
  accepted_terms_at      DateTime?
  accepted_terms_version String?
  reset_token            String?
  reset_token_expiry     DateTime?
  created_at             DateTime          @default(now())
  updated_at             DateTime          @updatedAt
  deleted_at             DateTime?
  audit_logs             audit_log[]
  cares                  care[]
  folders_responsible    folder[]          @relation("ProfessionalResponsible")
  subscriber             subscriber        @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  regulations_analyzed   regulation[]      @relation("regulation_analyzer")
  regulations_created    regulation[]      @relation("regulation_creator")
  regulations_printed    regulation[]      @relation("regulation_printer")
  care_usage_ranks       care_usage_rank[]
  suggestions            suggestion[]
  notifications          notification[]

  @@unique([subscriber_id, cpf])
  @@index([subscriber_id])
  @@index([email]) // Login rápido
}

model regulation {
  id                      Int               @id @default(autoincrement())
  uuid                    String            @unique @default(uuid())
  subscriber_id           Int
  id_code                 String?
  patient_id              Int?
  responsible_id          Int?
  request_date            DateTime?
  scheduled_date          DateTime?
  status                  status?
  notes                   String?
  clinical_indication     String?
  cid                     String?
  url_requirement         String?
  url_pre_document        String?
  url_current_document    String?
  folder_id               Int?
  relationship            relationship?
  priority                priority?         @default(eletivo)
  type_declaration        type_declaration?
  requesting_professional String?
  creator_id              Int?
  analyzed_id             Int?
  printer_id              Int?
  supplier_id             Int?
  history                 Int?
  version_document        Int?
  created_at              DateTime          @default(now())
  updated_at              DateTime          @updatedAt
  deleted_at              DateTime?

  cares         care_regulation[]
  analyzer      professional?     @relation("regulation_analyzer", fields: [analyzed_id], references: [id])
  creator       professional?     @relation("regulation_creator", fields: [creator_id], references: [id])
  folder        folder?           @relation(fields: [folder_id], references: [id])
  patient       patient?          @relation("PatientRegulation", fields: [patient_id], references: [id])
  printer       professional?     @relation("regulation_printer", fields: [printer_id], references: [id])
  responsible   patient?          @relation("ResponsibleRegulation", fields: [responsible_id], references: [id])
  subscriber    subscriber        @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  supplier      supplier?         @relation(fields: [supplier_id], references: [id])
  notifications notification[]

  @@index([subscriber_id])
  @@index([patient_id])
  @@index([folder_id])
  @@index([supplier_id])
  @@index([creator_id])
  @@index([analyzed_id])
  @@index([printer_id])
  @@index([subscriber_id, status]) // Otimização para filtros de status por assinante
  @@index([subscriber_id, created_at]) // Otimização para ordenação e relatórios
}

model supplier {
  id            Int          @id @default(autoincrement())
  uuid          String       @unique @default(uuid())
  subscriber_id Int
  name          String
  trade_name    String
  cnpj          String
  postal_code   String?
  city          String?
  state         String?
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
  deleted_at    DateTime?
  cares         care[]
  regulations   regulation[]
  subscriber    subscriber   @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@unique([subscriber_id, cnpj])
  @@index([subscriber_id])
}

model care_regulation {
  id            Int      @id @default(autoincrement())
  subscriber_id Int
  care_id       Int
  regulation_id Int
  quantity      Int      @default(1)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  subscriber subscriber @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  care       care       @relation(fields: [care_id], references: [id], onDelete: Cascade)
  regulation regulation @relation(fields: [regulation_id], references: [id], onDelete: Cascade)

  @@unique([care_id, regulation_id])
  @@index([care_id])
  @@index([regulation_id])
  @@index([subscriber_id])
}

model care_usage_rank {
  id            Int      @id @default(autoincrement())
  subscriber_id Int
  user_id       Int? // null = ranking geral do subscriber
  care_id       Int
  usage_count   Int      @default(1)
  last_used_at  DateTime @default(now())
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  subscriber   subscriber    @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  professional professional? @relation(fields: [user_id], references: [id], onDelete: Cascade)
  care         care          @relation(fields: [care_id], references: [id], onDelete: Cascade)

  @@unique([subscriber_id, user_id, care_id])
  @@index([subscriber_id])
  @@index([subscriber_id, user_id])
  @@index([care_id])
  @@index([usage_count(sort: Desc)])
  @@index([last_used_at(sort: Desc)])
}

model notification {
  id              Int               @id @default(autoincrement())
  uuid            String            @unique @default(uuid())
  subscriber_id   Int
  professional_id Int?
  regulation_id   Int?
  title           String
  message         String
  type            notification_type
  milestone       String?
  metadata        Json? // ⭐ NOVO - Dados pré-processados
  is_read         Boolean           @default(false)
  read_at         DateTime?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  deleted_at      DateTime?

  subscriber   subscriber    @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  professional professional? @relation(fields: [professional_id], references: [id], onDelete: Cascade)
  regulation   regulation?   @relation(fields: [regulation_id], references: [id])

  @@index([subscriber_id])
  @@index([professional_id]) // Index to optimize notification queries by professional
  @@index([regulation_id])
  @@index([created_at])
  @@index([subscriber_id, created_at]) // Otimização para buscar notificações recentes
}

model whatsapp_config {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  subscriber_id Int      @unique
  instance_name String   @unique
  api_key       String?
  provider      String   @default("evolution") // 'evolution', 'official', 'mock'
  credentials   Json? // Store extra configs like Webhook Verify Token, WABA ID, etc.
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  subscriber subscriber @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@index([subscriber_id])
}

model suggestion {
  id              Int       @id @default(autoincrement())
  subscriber_id   Int
  user_id         Int
  field_name      String
  term            String
  term_normalized String
  usage_count     Int       @default(1)
  last_used_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  professional professional @relation(fields: [user_id], references: [id], onDelete: Cascade)
  subscriber   subscriber   @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)

  @@unique([subscriber_id, user_id, field_name, term_normalized])
  @@index([subscriber_id, user_id, field_name])
}

// ============================================
// CHAT IA - IARA (Sistema de Chat Inteligente)
// ============================================

model chat_conversation {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid())
  subscriber_id Int
  user_id       Int? // professional_id ou patient_id
  user_type     String? // 'professional' ou 'patient'
  context       Json? // Contexto da conversa (lista de pacientes pendentes, intenção original, etc)
  started_at    DateTime  @default(now())
  ended_at      DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  deleted_at    DateTime?

  subscriber subscriber     @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  messages   chat_message[]

  @@index([subscriber_id])
  @@index([user_id, user_type])
  @@index([subscriber_id, started_at])
}

model chat_message {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  subscriber_id   Int
  conversation_id Int
  role            String // 'user', 'assistant', 'system'
  content         String    @db.Text
  tokens_used     Int?
  model           String?
  metadata        Json? // Informações extras como fontes, tempo de execução, etc
  created_at      DateTime  @default(now())
  deleted_at      DateTime?

  subscriber   subscriber        @relation(fields: [subscriber_id], references: [id], onDelete: Cascade)
  conversation chat_conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@index([created_at])
  @@index([subscriber_id])
}

enum audit_action {
  create
  update
  delete
  view
}

enum status {
  in_progress
  approved
  denied
  returned
}

enum unit_measure {
  mg
  g
  mcg
  kg
  ml
  l
  amp
  comp
  caps
  fr
  tub
  dose
  ui
  cx
  un
  sessao
  diaria
  medida
  pomada
  creme
  gel
}

enum priority {
  eletivo
  urgencia
  emergencia
}

enum sex {
  masculino
  feminino
  outro
  nao_informado
}

enum role {
  admin_manager
  admin_municipal
  typist
}

enum relationship {
  amigo_a
  genitor_a
  cuidador_a
  namorado_a
  esposo_a
  tio_a
  irma_o
  primo_a
  sobrinho_a
}

enum resource_origin {
  nao_especificado
  municipal
  estadual
  federal
}

enum type_declaration {
  requerimento_1
  requerimento_2
  residencia_pec
  residencia_cadsus
  atualizacao_cadsus
  ajuda_de_custo
  exame_alto_custo
  autorizacao
  desistencia
  aih
  transporte
  cer
  medicamento_continuo
  assistencia_farmaceutica
}

enum notification_type {
  PRAZO
  PRIORIDADE
  QUANTIDADE_ATINGIDA
  AGENDAMENTO
}
